<div class="modal fade" id="modalHargaProfile" tabindex="-1" aria-labelledby="modalHargaProfile" aria-hidden="true">
  <div class="modal-dialog">

  <div id="myloadingSpinner" class="text-center py-4">
    <div class="spinner-border text-primary" role="status"></div>
    <div>Memuat data profile...</div>
  </div>
  <div class="table-responsive">
  <table class="table d-none" id="myprofileTable">
      <thead id="mythead" class="table text-light d-none">
        <tr>
          <th>#no.</th>
          <th>Nama Profile</th>
          <th>Rate Limit</th>
          <th>Shared Users</th>
          <th>Session Timeout</th>
          <th>Harga (Rp)</th>
          <th>Aksi</th>
        </tr>
      </thead>
    <tbody id="profileTable"></tbody>
  </table>
</div>
  <nav>
    <ul class="pagination justify-content-center mt-3" id="paginate"></ul>
  </nav>

<script>
const fbpageSize = 10;
let fbcurrentPage = 1;
let allProfilesfb = [];

async function loadmyProfiles() {
  spinner(true);

  const user = firebase.auth().currentUser;
  if (!user) return;

  const idToken = await user.getIdToken();
  const response = await fetch('{{site.php_url}}/php/get_profilesUser.php', {
    headers: {
      'Authorization': 'Bearer ' + idToken,
      'Content-Type': 'application/json'
    }
  });

  const result = await response.json();
  if (!result.success) {
    showToast("Gagal", "Gagal ambil data: " + result.message, "error");
    spinner(false);
    return;
  }

  allProfiles = (result.data || []).filter(p => p && p.name);
  rendermyProfiles();

  spinner(false);
}

function spinner(isLoading) {
  document.getElementById('myloadingSpinner').classList.toggle('d-none', !isLoading);
  document.getElementById('myprofileTable').classList.toggle('d-none', isLoading);
  document.getElementById('mythead').classList.toggle('d-none', isLoading);
}

const myignoreList = ['default', 'admin', 'default-trial'];

function rendermyProfiles() {
  const start = (fbcurrentPage - 1) * fbpageSize;
  const end = start + fbpageSize;
  const pageItems = allProfilesfb.slice(start, end);
  const tbody = document.getElementById('profileTable');
  tbody.innerHTML = "";

  pageItems.forEach((p, i) => {
    if (!p.name || myignoreList.includes(p.name.toLowerCase())) return;

    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td>${start + i + 1}</td>
      <td>${p.name || '-'}</td>
      <td>${p.rate_limit || '-'}</td>
      <td>${p.session_timeout || '-'}</td>
      <td>${p.shared_users || '-'}</td>
      <td>${p.price ? 'Rp ' + p.price.toLocaleString() : '-'}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editProfile('${p.name}')">
          <i class="bi bi-pencil-square"></i>
        </button>
        <button class="btn btn-danger btn-sm btn-delete" data-id="${p.keyId}" data-name="${p.name}">
          <i class="bi bi-trash3"></i>
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });

  renderPaginate();
}

function editmyProfile(name) {
  showToast('Perhatian', 'Edit belum diimplementasi di UI. (backend sudah siap)', 'warning');
}

let myselectedProfile = null;

function myDeleteConfirm(keyId, name) {
  myselectedProfile = { keyId, name };
  document.getElementById('globalConfirmMessage').textContent = `Yakin ingin hapus profile "${name}"?`;
  new bootstrap.Modal(document.getElementById('globalConfirm')).show();
}

document.addEventListener('DOMContentLoaded', () => {
  document.body.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-delete');
    if (!btn) return;

    const keyId = btn.getAttribute('data-id');
    const name = btn.getAttribute('data-name');
    myDeleteConfirm(keyId, name);
  });

  document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
    if (!myselectedProfile) return;

    const user = firebase.auth().currentUser;
    const token = await user.getIdToken();

    const response = await fetch('{{site.php_url}}/php/deleteProfiles.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ '.id': selectedProfile.keyId })
    });

    const result = await response.json();

    if (result.success) {
      showToast('Sukses', 'âœ… Profile berhasil dihapus', 'success');
      setTimeout(() => {
        loadmyProfiles();
      }, 1000);
    } else {
      showToast('Gagal', result.message || 'Gagal menghapus profile', 'error');
    }

    myselectedProfile = null;
    bootstrap.Modal.getInstance(document.getElementById('globalConfirm')).hide();
  });
});

function renderPaginate() {
  const totalPages = Math.ceil(allProfilesfb.length / fbpageSize);
  const paginate = document.getElementById('paginate');
  paginate.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const li = document.createElement('li');
    li.className = `page-item ${i === fbcurrentPage ? 'active' : ''}`;
    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
    li.addEventListener('click', function (e) {
      e.preventDefault();
      fbcurrentPage = i;
      rendermyProfiles();
    });
    paginate.appendChild(li);
  }
}

firebase.auth().onAuthStateChanged(user => {
  if (user) loadmyProfiles();
});
</script>

  </div>
</div>